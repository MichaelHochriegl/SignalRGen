using System.Text;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using Microsoft.CodeAnalysis.Text;
using SignalRGen.Generator.Common;
using static Microsoft.CodeAnalysis.CSharp.SyntaxFactory;

namespace SignalRGen.Generator.Sources;

internal static class HubClientSource
{
    private const string HubClientTemplate = """
                                             //------------------------------------------------------------------------------
                                             // <auto-generated>
                                             //     This code was generated by a tool.
                                             //
                                             //     Changes to this file may cause incorrect behavior and will be lost if
                                             //     the code is regenerated.
                                             // </auto-generated>
                                             //------------------------------------------------------------------------------

                                             {躞轭珞

                                             #nullable enable

                                             namespace {钺礤箴徙逦犴妪;

                                             /// <summary>
                                             /// Represents a HubClient for the <see cref = "{桴饷扉孱羯铘弪驷沐"/> interface.
                                             /// </summary>
                                             public class {桴馕犴妪 : HubClientBase, IHubClient
                                             {
                                                 public static string HubUri { get; } = "{桴庹蜷";
                                                 public {桴馕犴妪(IHubConnectionBuilder hubConnectionBuilder) : base(hubConnectionBuilder)
                                                 {
                                                 }
                                                 
                                             {箦蝣弪燥渺殄铘湾翳镤簖
                                             
                                             {沆殄铘燥渝蝣弪湾翳镤簖
                                             
                                                 
                                                 protected override void RegisterHubMethods()
                                                 {
                                                 {镱湾翳镤簖
                                                 }
                                             }
                                             
                                             private void ValidateHubConnection()
                                             {
                                                 if (_hubConnection is null)
                                                 {
                                                     throw new InvalidOperationException("The HubConnection is not started! Call `StartAsync` before initiating any actions.");
                                                 }
                                             }
                                             """;
    private const string ServerToClientMethodTemplate = """
                                                            /// <summary>
                                                            /// Is invoked whenever the client method {殇孱糸骈弪 of the <see cref = "{桴饷扉孱羯铘弪驷沐"/> gets invoked.
                                                            /// </summary>
                                                            public Func<{疳蜥礤翦蛟疱簖, Task>? On{殇孱糸骈弪 = default;
                                                            private Task {殇孱糸骈弪Handler({疳蜥礤翦蛱轶酏)
                                                            {
                                                                return On{殇孱糸骈弪?.Invoke({疳蜥礤翦蝮) ?? Task.CompletedTask;
                                                            }
                                                        """;

    private const string ClientToServerMethodTemplate =
        """
            public {蝈趱蝾赠疱 Invoke{殇孱糸骈弪Async({疳蜥礤翦蛱轶酏, CancellationToken ct = default)
            {
                ValidateHubConnection();
                return _hubConnection!.InvokeAsync{珏铄蜷阋弭躜钤疱("{殇孱糸骈弪", {疳蜥礤翦蝮, cancellationToken: ct);
            }
        """;
    private const string OnMethodTemplate = """
                                                _hubConnection?.On<{疳蜥礤翦蛟疱簖>("{殇孱糸骈弪", {殇孱糸骈弪Handler);
                                            """;

    internal static SourceText GetSourceText(HubClientToGenerate hubClientToGenerate)
    {
        var allUsings =
            hubClientToGenerate.Usings
                .Append(new CacheableUsingDeclaration("using Microsoft.AspNetCore.SignalR.Client;"))
                .Append(new CacheableUsingDeclaration($"using {hubClientToGenerate.InterfaceNamespace};"));
        var usings = string.Join("\n", allUsings.Select(u => u.UsingNamespace));

        var serverToClientMethods = hubClientToGenerate.ServerToClientMethods.Select(method =>
            {
                var parameterTypes = string.Join(", ", method.Parameters.Select(p => p.Type));
                var parameterList = string.Join(", ", method.Parameters.Select(p => $"{p.Type} {p.Name}"));
                var parameters = string.Join(", ", method.Parameters.Select(p => p.Name));

                return ServerToClientMethodTemplate
                    .Replace("{桴饷扉孱羯铘弪驷沐", hubClientToGenerate.InterfaceName)
                    .Replace("{殇孱糸骈弪", method.Identifier)
                    .Replace("{疳蜥礤翦蛟疱簖", parameterTypes)
                    .Replace("{疳蜥礤翦蛱轶酏", parameterList)
                    .Replace("{疳蜥礤翦蝮", parameters);
            })
            .ToArray();

        var clientToServerMethods = hubClientToGenerate.ClientToServerMethods.Select(method =>
        {
            var parameterTypes = string.Join(", ", method.Parameters.Select(p => p.Type));
            var parameterList = string.Join(", ", method.Parameters.Select(p => $"{p.Type} {p.Name}"));
            var parameters = string.Join(", ", method.Parameters.Select(p => p.Name));

            var template = ClientToServerMethodTemplate.Replace("{桴饷扉孱羯铘弪驷沐", hubClientToGenerate.InterfaceName)
                .Replace("{殇孱糸骈弪", method.Identifier)
                .Replace("{疳蜥礤翦蛟疱簖", parameterTypes)
                .Replace("{疳蜥礤翦蛱轶酏", parameterList)
                .Replace("{疳蜥礤翦蝮", parameters)
                .Replace("{蝈趱蝾赠疱", method.ReturnType)
                .Replace("{珏铄蜷阋弭躜钤疱", method.ReturnType.Replace("Task", ""));

            return template;
        });

        var onMethods = hubClientToGenerate.ServerToClientMethods
            .Select(method =>
            {
                var parameterTypes = string.Join(", ", method.Parameters.Select(p => p.Type));

                return OnMethodTemplate.Replace("{殇孱糸骈弪", method.Identifier)
                    .Replace("{疳蜥礤翦蛟疱簖", parameterTypes);
            })
            .ToArray();

        var template = HubClientTemplate
            .Replace("{躞轭珞", usings)
            .Replace("{钺礤箴徙逦犴妪", "SignalRGen.Generator")
            .Replace("{桴馕犴妪", hubClientToGenerate.HubName)
            .Replace("{桴庹蜷", hubClientToGenerate.HubUri)
            .Replace("{桴饷扉孱羯铘弪驷沐", hubClientToGenerate.InterfaceName)
            .Replace("{箦蝣弪燥渺殄铘湾翳镤簖", string.Join("\n", serverToClientMethods))
            .Replace("{沆殄铘燥渝蝣弪湾翳镤簖", string.Join("\n", clientToServerMethods))
            .Replace("{镱湾翳镤簖", string.Join("\n\t", onMethods));


        return SourceText.From(template, Encoding.UTF8);
    }
}