@page "/Chat"
@using SignalRGen.Example.Contracts

@* We inject the generated client. *@
@* Notice that we use the actual type, not the interface we defined. *@
@inject ChatHubContractClient ChatHubClient;

<h3>Chat</h3>

<p>This is a really crude example of a chat that uses SignalR generated by SignalRGen to communicate.</p>
<p>It is kept simple to better showcase the generated SignalR code. This is not how a real chat app would look like.</p>
<p>To get the example working it is best to duplicate this tab a couple of times and open them in different browser tabs.
    After that enter a username in each tab and join the chat room. You should be able to see the sent message on all tabs.</p>
<div class="chat-card">
    <div class="chat-header">
        @if (!_joined)
        {
            <strong>Join the chat</strong>
        }
        else
        {
            <span>Chatting as: <strong>@_confirmedUsername</strong></span>
        }
    </div>

    <div class="chat-body">
        @if (!_joined)
        {
            <p class="msg msg-system">Enter a username below to connect.</p>
        }
        
        @foreach (var msg in _messages)
        {
            @* Simple check to style system messages differently from user messages *@
            <div class="msg @(msg.StartsWith("~~") ? "msg-system" : "msg-user")">
                @msg
            </div>
        }
    </div>

    <div class="chat-footer">
        @if (!_joined)
        {
            <input @bind="_username" @bind:event="oninput" @onkeydown="@EnterJoin"
                   id="username-input"
                   class="form-input" placeholder="Enter username..." />
            <button @onclick="Join" disabled="@string.IsNullOrWhiteSpace(_username)" 
                    id="join-button"
                    class="btn-primary">Join</button>
        }
        else
        {
            <input @bind="_message" @bind:event="oninput" @onkeydown="@EnterSend" 
                   id="message-input"
                   class="form-input" placeholder="Type a message..." />
            <button @onclick="SendMessage" disabled="@string.IsNullOrWhiteSpace(_message)" 
                    id="send-button"
                    class="btn-primary">Send</button>
        }
    </div>
</div>

@code {
    private string _username = string.Empty;
    private string _confirmedUsername = string.Empty;
    private bool _joined = false;
    private string _message = string.Empty;
    private List<string> _messages = new();

    private async Task Join()
    {
        if (!string.IsNullOrWhiteSpace(_username))
        {
            _confirmedUsername = _username;
            _username = string.Empty;
            _joined = true;

            // Subscribe to events using named methods for cleaner code & unsubscribe capability
            ChatHubClient.OnUserJoined += HandleUserJoined;
            ChatHubClient.OnUserLeft += HandleUserLeft;
            ChatHubClient.OnMessageReceived += HandleMessageReceived;
        
            var headers = new Dictionary<string, string> { { "username", _confirmedUsername } };
            await ChatHubClient.StartAsync(headers: headers);
        }
    }

    private async Task HandleUserJoined(string user)
    {
        _messages.Add($"~~ User '{user}' joined ~~");
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleUserLeft(string user)
    {
        _messages.Add($"~~ User '{user}' left ~~");
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleMessageReceived(ChatMessage message)
    {
        _messages.Add($"{message.User}: {message.Message}");
        await InvokeAsync(StateHasChanged);
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(_message))
        {
            await ChatHubClient.InvokeSendMessageAsync(_message);
            _messages.Add($"{_confirmedUsername}: {_message}");
            _message = string.Empty;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    // Nice-to-have: Allow pressing "Enter" to submit
    private async Task EnterJoin(KeyboardEventArgs e) { if (e.Code == "Enter") await Join(); }
    private async Task EnterSend(KeyboardEventArgs e) { if (e.Code == "Enter") await SendMessage(); }

    public async ValueTask DisposeAsync()
    {
        ChatHubClient.OnUserJoined -= HandleUserJoined;
        ChatHubClient.OnUserLeft -= HandleUserLeft;
        ChatHubClient.OnMessageReceived -= HandleMessageReceived;
        await ChatHubClient.StopAsync();
    }

}